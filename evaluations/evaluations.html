<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Liste des √©valuations</title>
  <style>
      :root {
      --green: #4CAF50; /* Un vert vif */
      --lightGreen: #81C784; /* Un vert clair et frais */
      --lightChocolate: #d16524;
      --background-color: white;
      --pink: #eb7880;
      --white: #fcffff;
      --purple: #caa7d6;
      --blue: #18709f;
      --lightBlue: #4adde7;
      --rouge: #F44336; /* Un rouge vif */
      --border-radius: 10px;
      --transition-speed: 0.35s;
      }
/* Base g√©n√©rale */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f8f9fa;
  color: #333;
  padding: 20px;
  line-height: 1.6;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap; /* pour √©viter les d√©bordements en petit √©cran */
}

/* Section principale (√©valuations) */
#listeEvaluations {
  flex: 1;
  min-width: 60%;
}

/* Bilans align√©s √† droite */
#bilans {
  width: 300px;
  background-color: #ffffff;
  border: 1px solid #ddd;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-radius: 6px;
  margin-left: auto;
  position: absolute;
  top: 40px;
  right: 50px;
}

/* Optionnel : am√©lioration des <select> dans #bilans */
#bilans select {
  width: 100%;
  margin-top: 10px;
  margin-bottom: 15px;
  padding: 10px;
  font-size: 16px;
  border-radius: 4px;
  border: 1px solid #ccc;
}

#commentaires {
  width: 300px;
  background-color: #ffffff;
  border: 1px solid #ddd;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-radius: 6px;
  margin-left: auto;
  position: absolute;
  bottom: 70px;
  right: 50px;
}
.commentaireButton {
  background: #d6dade;
  border: 1px dotted #caa7d6;
}
.commentaireButton:hover {
  background: #007BFF;
  border: 1px dotted #caa7d6;
}

h1 {
  color: #222;
  font-size: 28px;
  margin-bottom: 20px;
}

/* Liste des √©valuations */
ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

li {
  background: #ffffff;
  border: 1px solid #ddd;
  padding: 12px 16px;
  margin-bottom: 10px;
  border-radius: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.2s ease-in-out;
}

li:hover {
  background: #f1f1f1;
}

a {
  text-decoration: none;
  color: #007BFF;
  font-weight: 600;
  transition: color 0.2s ease-in-out;
}

a:hover {
  text-decoration: underline;
  color: #0056b3;
}

/* Boutons */
button,
.createButton {
  background-color: #007BFF;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 10px 15px;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.3s ease;
  margin-top: 10px;
}

button:hover,
.createButton:hover {
  background-color: #0056b3;
}

/* Icones boutons */
.navJournalButton {
  max-width: 24%;
  padding: 7px;
}

/* S√©lecteurs */
select {
  appearance: none;
  background-color: white;
  border: 1px solid #ccc;
  padding: 10px 12px;
  font-size: 16px;
  border-radius: 4px;
  color: #333;
}

#selectProf:hover{
  cursor: pointer;
}

/* Style pour la bo√Æte de dialogue */
#dialog {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    border: 1px solid #ccc;
    border-radius: 22px;
    padding: 20px;
    background-color: white;
    z-index: 1000;
    width: 210px;
}
#overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    z-index: 999;
}
#passwordInput{
    width: 90%;
}
#confirmButton {
    background: var(--green);
    width: 150px;

}
#cancelButton {
    background: var(--rouge);
    width: 150px;

}
  </style>
</head>
<body>
  <div id="overlay" style="display: none;"></div>
  <div id="dialog"  style="display: none;">
      <label for="passwordInput">Mot de passe :</label>
      <input type="password" id="passwordInput"/>
      <button id="confirmButton">Valider</button>
      <button id="cancelButton">Annuler</button>
  </div>


  <h1>üìö √âvaluations</h1>
  <ul id="listeEvaluations"></ul>

  <hr />
  <button onclick="window.location.href='eval-setup.html';" class="createButton">Cr√©er une nouvelle fiche d'√©val</button>
  <hr />


  <div id="bilans">
    <h1>‚öôÔ∏è G√©n√©rer un Bilan</h1>
    <select id="selectAnnee">
      <option value="">üìÖ S√©lectionner une ann√©e</option>
    </select>
    
    <select id="selectPeriode" style="display:none;">
      <option value="">üïì S√©lectionner une p√©riode</option>
    </select>
    
    <select id="selectProf" style="display:none;">
      <option value="">üë©‚Äçüè´ S√©lectionner un prof</option>
    </select>
    
    <select id="selectEleve" style="display:none;" onchange="redirigerVersEleve()">
      <option value="">üëß S√©lectionner un.e √©l√®ve</option>
    </select>
      
    <p id="message">‚ö†Ô∏è S'assurer que les √©valuations ont le statut <span style="color: green">"termin√©e"</span> pour n'oublier aucune comp√©tence. Vous pourrez aussi en ajouter manuellement ci-apr√®s.</p>
  </div>

  <div id="commentaires">
    <h1>üí¨ Commentaires</h1>
    <button class="commentaireButton" onclick="window.location.href='commentaires.html';">üß© Rassembler</button>
  </div>
  
  
  

  <script>
    // V√©rifier si l'utilisateur est un adulte -----------------------------------------------
let isAdmin = JSON.parse(localStorage.getItem('admin')) || false;

// Fonction qui ferme la bo√Æte de dialogue
function closeDialog() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('dialog').style.display = 'none';
    document.getElementById('passwordInput').value = ''; // R√©initialiser le champ de saisie
}

// Fonction qui valide le mot de passe
function validatePassword(password) {
    return password === "1968" || password === "dirvaulx";
}

// Fonction pour afficher la bo√Æte de dialogue de mot de passe
function showPasswordDialog() {
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('dialog').style.display = 'block';

    const passwordInput = document.getElementById('passwordInput');
    passwordInput.focus();
}

if (!isAdmin) {
    showPasswordDialog();

    const passwordInput = document.getElementById('passwordInput');

    // √âcouteur touche ENTER (√† placer ici pour √©viter doublons)
    passwordInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            const password = passwordInput.value;
            if (validatePassword(password)) {
                localStorage.setItem('password', password);  // Stocker le mot de passe
                localStorage.setItem('admin', true);          // M√©moriser que c'est un admin
                closeDialog();
                isAdmin = true;
            } else {
                alert("Code adulte requis");
            }
        }
    });

    document.getElementById('confirmButton').onclick = function() {
        const password = passwordInput.value;
        if (validatePassword(password)) {
            localStorage.setItem('password', password);
            localStorage.setItem('admin', true);
            closeDialog();
            isAdmin = true;
        } else {
            window.top.location.href = "../index.html";
        }
    };

    document.getElementById('cancelButton').onclick = function() {
        window.top.location.href = "../index.html";
    };
} else {
    // L'utilisateur est d√©j√† admin, ne rien faire
}
//-----------------------------------------------------------


    let evaluations = [];

    async function chargerEvaluations() {
  const res = await fetch("/liste-domaines");
  if (!res.ok) return;

  evaluations = await res.json();
  console.log("√âvaluations charg√©es :", evaluations);

  // Affichage global des √©valuations (ind√©pendant des filtres)
  const listeEvaluations = document.getElementById("listeEvaluations");
  evaluations.forEach(({ annee, periode, domaine, etat }) => {
    const li = document.createElement("li");

    const lien = document.createElement("a");
    lien.href = `eval.html?domaine=${encodeURIComponent(domaine)}`;
    lien.textContent = `üìù ${annee} - ${domaine}`;
    li.appendChild(lien);

    const etatSpan = document.createElement("span");
    etatSpan.textContent = `(${etat})`;
    etatSpan.style.color = etat === "termin√©e" ? "green" : "orange";
    li.appendChild(etatSpan);

    const supprimerBtn = document.createElement("span");
        supprimerBtn.textContent = "üóëÔ∏è";
        supprimerBtn.title = "Supprimer cette √©valuation";
        supprimerBtn.style.color = "red";
        supprimerBtn.style.cursor = "pointer";
  
        supprimerBtn.onclick = async () => {
          if (confirm(`Supprimer l'√©valuation "${domaine}" ?`)) {
            const res = await fetch(`/supprimer-evaluation/${encodeURIComponent(domaine)}`, { method: 'DELETE' });
            if (res.ok) {
              li.remove();
            } else {
              alert("Erreur lors de la suppression.");
            }
          }
        };

        li.appendChild(supprimerBtn);

    listeEvaluations.appendChild(li);
  });
}
chargerEvaluations();


async function chargerBilans() {
  const res = await fetch("/liste-domaines");
  if (!res.ok) return;

  evaluations = await res.json();
  console.log("√âvaluations charg√©es :", evaluations);

  // Extraire toutes les ann√©es sans filtrer par √©tat
  const annees = [...new Set(evaluations.map(e => e.annee))].sort();
  console.log("Ann√©es disponibles :", annees);

  const selectAnnee = document.getElementById("selectAnnee");
  selectAnnee.innerHTML = '<option value="">üìÖ  S√©lectionner une ann√©e </option>';

  annees.forEach(annee => {
    const option = document.createElement("option");
    option.value = annee;
    option.textContent = annee;
    selectAnnee.appendChild(option);
  });

  console.log("Options ann√©e ajout√©es :", selectAnnee.innerHTML);

  selectAnnee.addEventListener("change", function () {
    const anneeChoisie = this.value;
    console.log("Ann√©e choisie :", anneeChoisie);

    // Extraire les p√©riodes pour l'ann√©e choisie
    const periodes = [...new Set(
      evaluations.filter(e => e.annee === anneeChoisie).map(e => e.periode)
    )].sort();
    console.log("P√©riodes disponibles pour l'ann√©e choisie :", periodes);

    const selectPeriode = document.getElementById("selectPeriode");
    selectPeriode.innerHTML = '<option value="">üïì S√©lectionner une p√©riode </option>';
    selectPeriode.style.display = "inline-block"; // Assurez-vous que ce s√©lecteur devient visible

    periodes.forEach(p => {
      const option = document.createElement("option");
      option.value = p;
      option.textContent = p;
      selectPeriode.appendChild(option);
    });

    console.log("Options p√©riode ajout√©es :", selectPeriode.innerHTML);

    document.getElementById("selectProf").style.display = "none";
    document.getElementById("selectEleve").style.display = "none";
  });

  document.getElementById("selectPeriode").addEventListener("change", function () {
    const annee = document.getElementById("selectAnnee").value;
    const periode = this.value;
    console.log("P√©riode choisie :", periode);

    // Extraire tous les professeurs uniques pour cette ann√©e et p√©riode en prenant en compte tous les √©l√®ves
    const profs = [...new Set(
      evaluations
        .filter(e => e.annee === annee && e.periode === periode)
        .flatMap(e => e.eleves.map(el => el.prof)) // On r√©cup√®re tous les professeurs des √©l√®ves
    )].sort();
    console.log("Professeurs disponibles pour la p√©riode choisie :", profs);

    const selectProf = document.getElementById("selectProf");
    selectProf.innerHTML = '<option value="">üë©‚Äçüè´ S√©lectionner un.e prof </option>';
    selectProf.style.display = "inline-block"; // Assurez-vous que ce s√©lecteur devient visible

    profs.forEach(p => {
      const option = document.createElement("option");
      option.value = p;
      option.textContent = p;
      selectProf.appendChild(option);
    });

    console.log("Options professeur ajout√©es :", selectProf.innerHTML);

    document.getElementById("selectEleve").style.display = "none";
  });

  document.getElementById("selectProf").addEventListener("change", function () {
    const annee = document.getElementById("selectAnnee").value;
    const periode = document.getElementById("selectPeriode").value;
    const prof = this.value;
    console.log("Professeur choisi :", prof);

    // Extraire les √©l√®ves pour l'ann√©e, la p√©riode et le professeur choisis
    const elevesSet = new Set();
    evaluations
      .filter(e => e.annee === annee && e.periode === periode)
      .forEach(e => {
        e.eleves
          .filter(el => el.prof === prof)  // Filtrer les √©l√®ves ayant ce professeur
          .forEach(el => elevesSet.add(el.nom)); // Ajouter les noms des √©l√®ves
      });

    const eleves = [...elevesSet].sort();
    console.log("√âl√®ves disponibles pour le professeur choisi :", eleves);

    const selectEleve = document.getElementById("selectEleve");
    selectEleve.innerHTML = '<option value="">üëß S√©lectionner un √©l√®ve </option>';
    selectEleve.style.display = "inline-block"; // Assurez-vous que ce s√©lecteur devient visible

    eleves.forEach(nom => {
      const option = document.createElement("option");
      option.value = nom;
      option.textContent = nom;
      selectEleve.appendChild(option);
    });

    console.log("Options √©l√®ve ajout√©es :", selectEleve.innerHTML);
  });
}


chargerBilans();
  
function redirigerVersEleve() {
  const eleve = document.getElementById("selectEleve").value;
  const annee = document.getElementById("selectAnnee").value;
  const periode = document.getElementById("selectPeriode").value;

  if (eleve && annee && periode) {
    window.location.href = `eleve.html?eleve=${encodeURIComponent(eleve)}&annee=${encodeURIComponent(annee)}&periode=${encodeURIComponent(periode)}`;
  }
}


  document.getElementById('selectAnnee').addEventListener('click', function(){
    document.getElementById('message').style.display = "none";
  });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>√âvaluation ‚Äì √âdition</title>

  <style>
      :root {
      --green: #4CAF50; /* Un vert vif */
      --lightGreen: #81C784; /* Un vert clair et frais */
      --lightChocolate: #d16524;
      --background-color: white;
      --pink: #eb7880;
      --white: #fcffff;
      --purple: #caa7d6;
      --blue: #18709f;
      --lightBlue: #4adde7;
      --rouge: #F44336; /* Un rouge vif */
      --border-radius: 10px;
      --transition-speed: 0.35s;
      }
      @font-face {
      font-family: 'ComicSansMS';
      src: url('../polices/ComicSansMS.woff2') format('woff2'),
            url('../polices/ComicSansMS.ttf') format('truetype');
      }

      * {
      box-sizing: border-box;
      border-radius: 10px;
      font-family: 'ComicSansMS', sans-serif;
      }
      body {
        user-select: none;
      }
    h1 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td {
      border: 2px solid #939393;
      padding: 1px;
      text-align: center;
      font-size: small;
  
    }
    th {
      background-color: #f4f4f4;
    }
    th[title] {
        cursor: help;
    }
    td:hover {
      cursor: pointer;
      background-color: #f0f8ff;
    }
    #competencesSollicitees{
        margin-top: 10px;
        padding-top: 20px;
    }

/* Style pour les boutons Retour, Imprimer */
.navJournalButton {
    max-width: 24%; padding: 7px;
}
.backButton {
    width: 10%;
    height: 50px;
    background-color: lightgray; /* Couleur grey */
    color: white; /* Couleur du texte */
    border: none; /* Pas de bordure */
    border-radius: 4px; /* Coins arrondis */
    padding: 10px 15px; /* Espace int√©rieur */
    cursor: pointer; /* Curseur en main */
    font-size: 16px; /* Taille de police */
    margin: 20px auto; /* Marge automatique pour centrer */
    text-align: center;
}
.backButton:hover {
    background-color: grey; /* Couleur grey */
}
.printButton {
    width: 10%;
    height: 50px;
    background-color: var(--purple); 
    color: white; /* Couleur du texte */
    border: none; /* Pas de bordure */
    border-radius: 4px; /* Coins arrondis */
    padding: 10px 15px; /* Espace int√©rieur */
    cursor: pointer; /* Curseur en main */
    font-size: 16px; /* Taille de police */
    margin: 20px auto; /* Marge automatique pour centrer */
    text-align: center;
    
}
.printButton:hover {
    background-color: purple; 
}
/* Cible la colonne commentaire dans le tableau */
td[data-comp="commentaire"],
th:has(> span.commentaire-header) {
  width: 40%;
  text-align: left;
  padding: 4px;
  word-wrap: break-word;
  white-space: pre-wrap;
}

/* R√©duire les autres colonnes √† un minimum utile */
td:not([data-comp="commentaire"]),
th:not(:has(> span.commentaire-header)) {
  width: 1%;
  font-size: x-small;
  padding: 2px;
}

/* √âviter que l'impression √©largisse tout */
@media print {
  .grise-a-imprimer {
      background-color: #e0e0e0 !important;
      border-radius: 0px;
      -webkit-print-color-adjust: exact; /* Pour forcer la couleur sur certains navigateurs */
      print-color-adjust: exact;
    }

  td, th {
    font-size: 10pt;
  }

  td[data-comp="commentaire"] {
    width: 40%;
  }
  .noPrint {
        display: none;
  }
}
.etatButton {
  position: fixed;
  top: 4%;
  right: 3%;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  color: white;
  font-weight: bold;
}

.etatButton[style*="green"] {
  background-color: green;
}

.etatButton[style*="orange"] {
  background-color: orange;
}

  </style>
</head>
<body>
  <h1 id="evalTitle">√âdition des √©valuations</h1>
  <label for="domaine" class="noPrint">Choisir un domaine :</label>
  <select id="domaineSelect" class="noPrint"></select>

  <table id="evalTable">
    <thead></thead>
    <tbody></tbody>
  </table>

  <br>
  <button id="backBtn" class="noPrint" style="border: 2px solid #999;" onclick="window.location.href='./evaluations.html';">üîô Retour</button>
  <button id="printBtn" class="noPrint" style="border: 2px solid #1e90ff;" onclick="imprimer()">üñ®Ô∏è Imprimer</button>
  <button id="ajouterEleveBtn" class="noPrint" style="border: 2px solid #28a745;">‚ûï Ajouter un nouvel √©l√®ve</button>
  <button id="supprimerEleveBtn" class="noPrint" style="border: 2px solid #dc3545;">üóëÔ∏è Supprimer un √©l√®ve</button>
  <button id="ajouterCompetenceBtn" class="noPrint" style="border: 2px solid #ffc107;">‚ûï Ajouter une comp√©tence</button>
  <button id="supprimerCompetenceBtn" class="noPrint" style="border: 2px solid #fd7e14;">üóëÔ∏è Supprimer une comp√©tence</button>
  

  <button id="exportCSVBtn" class="noPrint" style="border: 2px solid #6f42c1; display: none;">üì§ Exporter en CSV</button>
  <button id="telechargerJsonBtn" class="noPrint" style="border: 2px solid #6f42c1; display: none;">üíª Exporter en .json</button>




  <button id="changeEtat" class="etatButton noPrint" onclick="changerEtat()"></button>
  <div id="competencesSollicitees"></div>
  
<div style="text-align: right;">
  <a href="/logout" style="text-decoration:none; color: red;">D√©connexion</a>
</div>
  <script>
    
    // variables globales pour personnaliser l'impression de la page
    let domaineActuel = "";
    let periodeActuelle = "";
    let nomDuGroupe = "";

    let competencesUtilisees;
    
    
    // Lire domaine depuis l'URL
    const params = new URLSearchParams(window.location.search);
    const domaineParam = params.get("domaine");
    if (domaineParam) {
        //chargerEvaluation(domaineParam);
    }

    // Charger les donn√©es du domaine s√©lectionn√©
    async function chargerEvaluation(domaine) {
      const response = await fetch(`/evaluations/${domaine}.json`);
      if (!response.ok) {
        alert("Erreur lors du chargement des donn√©es.");
        return;
      }

      const data = await response.json();

        // M√©moriser domaine et p√©riode globalement
        domaineActuel = data.domaine;

        // Mettre √† jour le titre dynamiquement
        document.getElementById('evalTitle').innerText = `${domaineActuel}`;

      const table = document.getElementById('evalTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      const competences = data.competences;
      const descriptions = await chargerCompetencesGlobales(competences);
      

      const scores = data.scores;
      const eleves = data.eleves;

      // En-t√™te
      let headRow = '<tr><th>√âl√®ve</th><th>Prof</th>';

        for (const comp of competences) {
            if (comp === "commentaire") {
                headRow += `<th><span class="commentaire-header">${comp}</span></th>`;
            } else {
                const desc = descriptions[comp] || "";
                headRow += `<th title="${desc}">${comp}</th>`;
            }
        }
        headRow += '</tr>';
        thead.innerHTML = headRow;



      // Corps du tableau
      for (const eleveObj of eleves) {
        const nom = eleveObj.nom;
        const prof = eleveObj.prof;
        const ligne = document.createElement('tr');

        ligne.innerHTML = `<td>${nom}</td><td>${prof}</td>`;
        for (const comp of competences) {
          const td = document.createElement('td');
          let val = scores[nom]?.[comp] ?? '';
          // Si pas encore renseign√©, aller v√©rifier les p√©riodes pr√©c√©dentes
          if (!val && comp !== "commentaire") {
            try {
              const res = await fetch(`/deja-valide/${encodeURIComponent(nom)}/${encodeURIComponent(comp)}?periode=${encodeURIComponent(data.periode)}`);
              const { deja } = await res.json();
              if (deja) {
                val = "d√©j√†";
              }
            } catch (err) {
              console.error("Erreur lors de la v√©rification d√©j√† valid√©e ou non :", err);
            }
          }

          td.textContent = val;
          td.dataset.eleve = nom;
          td.dataset.comp = comp;

          // Ajout du comportement clic
          td.addEventListener('click', function () {
            const eleve = this.dataset.eleve;
            const comp = this.dataset.comp;
            const actuel = this.textContent.trim();

            if (comp === 'commentaire') {
              const baseCommentaire = actuel.split("**Comp√©tences valid√©es")[0]?.trim() || "";
              const nouveau = prompt("Entrer un commentaire :", baseCommentaire);
              if (nouveau === null) return;

              fetch(`/update-commentaire/${domaine}/${eleve}`, {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ commentaire: nouveau })
              })
              .then(res => res.json())
              .then(data => {
                this.textContent = data.commentaire;
              });

            } else {
              const prochaineValeur = cycleValeur(actuel);
              fetch(`/update-score/${domaine}/${eleve}/${comp}`, {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ valeur: prochaineValeur })
              })
              .then(() => {
                this.textContent = prochaineValeur;
              })
              .then(() => {
                this.textContent = prochaineValeur;

                // Mettre √† jour dynamiquement le commentaire
                fetch(`/evaluation/${domaine}`)
                    .then(res => res.json())
                    .then(data => {
                    const commentaire = data.scores[eleve]["commentaire"] || "";
                    const ligne = this.parentElement;
                    const cellules = ligne.querySelectorAll("td");
                    const indexCommentaire = [...cellules].findIndex(td => td.dataset.comp === "commentaire");
                    if (indexCommentaire !== -1) {
                        cellules[indexCommentaire].textContent = commentaire;
                    }
                    });
                });
            }
          });

          ligne.appendChild(td);
        }

        tbody.appendChild(ligne);
      }
    }

    function cycleValeur(val) {
      if (!val || val === "") return "oui";
      if (val === "oui") return "non";
      if (val === "non") return "d√©j√†";
      if (val === "d√©j√†") return "";
    }

// COMPETENCES NOMINATIVES : lecture du fichier competences.json
async function chargerCompetencesGlobales(competencesUtilisees) {
    const res = await fetch('/competences.json');
    if (!res.ok) {
        console.error("Erreur lors du chargement de competences.json");
        return {};
    }

    const data = await res.json();
    const competencesDictionnaire = data.competences;

    const listeDescriptions = competencesUtilisees
        .map(cle => {
            const desc = competencesDictionnaire[cle];
            return desc ? `<li>${cle} : ${desc}</li>` : null;
        })
        .filter(Boolean);

    const compDiv = document.getElementById('competencesSollicitees');
    compDiv.innerHTML = "<strong>Comp√©tences sollicit√©es :</strong><ul>" +
        listeDescriptions.join('') +
        "</ul>";

    return competencesDictionnaire;
}



// Charger les domaines disponibles dans le s√©lecteur
async function chargerDomaines() {
  const select = document.getElementById('domaineSelect');
  const res = await fetch('/liste-domaines');

  if (!res.ok) {
    alert("Erreur lors du chargement des domaines.");
    return;
  }

  const domaines = await res.json();
  
  // Vider le select avant d'ajouter les nouvelles options
  select.innerHTML = '';

  // Ajouter une option vide par d√©faut
  const optionDefaut = document.createElement('option');
  optionDefaut.value = '';
  optionDefaut.textContent = 'S√©lectionner un domaine';
  select.appendChild(optionDefaut);

  // Ajouter les domaines au select
  for (const domaineObj of domaines) {
    const option = document.createElement('option');
    option.value = domaineObj.domaine; // Utilise la propri√©t√© 'domaine'
    option.textContent = domaineObj.domaine; // Utilise la propri√©t√© 'domaine' pour afficher
    select.appendChild(option);
  }

  // Si l'URL a d√©j√† un domaine, on s√©lectionne l'option sans recharger
  const domaineParam = new URLSearchParams(window.location.search).get("domaine");
  if (domaineParam) {
    select.value = domaineParam;
    chargerEvaluation(domaineParam); // Charge les donn√©es pour le domaine
    chargerEtat(domaineParam); // Met √† jour l'√©tat du bouton
  } else if (domaines.length > 0) {
    select.value = domaines[0].domaine; // S√©lectionne le premier domaine par d√©faut
    chargerEvaluation(domaines[0].domaine); // Charge les donn√©es pour le premier domaine
    chargerEtat(domaines[0].domaine); // Met √† jour l'√©tat du bouton
  }
  select.addEventListener('change', () => {
    const selectedDomaine = select.value;
    chargerEvaluation(selectedDomaine);
    chargerEtat(selectedDomaine); // ‚úÖ ICI le param√®tre est bien transmis
  });

}

chargerDomaines();

async function chargerEtat(domaine) {
  const bouton = document.getElementById('changeEtat');
  if (!domaine || !bouton) return;

  const res = await fetch(`/evaluation/${encodeURIComponent(domaine)}`);
  if (!res.ok) {
    bouton.textContent = "Erreur";
    bouton.style.backgroundColor = "gray";
    return;
  }

  const data = await res.json();
  const etat = data.etat || "en cours";

  bouton.textContent = etat;
  bouton.style.backgroundColor = etat === 'termin√©e' ? 'green' : 'orange';
}



// Changer l'√©tat de "en cours" √† "termin√©e"
async function changerEtat() {
  const params = new URLSearchParams(window.location.search);
  const domaine = params.get('domaine');
  if (!domaine) return alert("Domaine introuvable.");

  const bouton = document.getElementById('changeEtat');
  const nouvelEtat = bouton.textContent.trim() === 'en cours' ? 'termin√©e' : 'en cours';

  try {
    const res = await fetch(`/update-etat/${encodeURIComponent(domaine)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ etat: nouvelEtat })
    });

    const data = await res.json();

    if (res.ok) {
      bouton.textContent = nouvelEtat;
      bouton.style.backgroundColor = nouvelEtat === 'termin√©e' ? 'green' : 'orange';
        if (nouvelEtat === 'termin√©e'){
          telechargerJSONFiche(domaine);
        }
    } else {
      console.error("R√©ponse serveur invalide :", data);
      alert("Erreur lors de la mise √† jour de l'√©tat.");
    }
  } catch (err) {
    console.error("Erreur JS/fetch :", err);
    alert("Erreur r√©seau ou interne.");
  }
}







  
function griserLesCasesDejaValidees() {
    const cellules = document.querySelectorAll('#evalTable td'); // S√©lectionne toutes les cellules du tableau

    cellules.forEach(td => {
        // Si le contenu de la cellule est "d√©j√†"
        if (td.textContent.trim() === "d√©j√†") {
            td.innerText = "oui"; // Remplacer "d√©j√†" par "oui"
            td.style.backgroundColor = "#ccc"; // Colorier la cellule en gris
            td.style.borderRadius = "0px"; // Enlever les coins arrondis
            td.classList.add('grise-a-imprimer'); // Ajouter une classe CSS pour imprimer
        }

        // Remplacer ** L23, E10... ** par du texte en gras
        td.innerHTML = td.innerHTML.replace(/\*\*(.*?)\*\*/g, '<br><strong>$1</strong>'); // Utiliser des expressions r√©guli√®res pour trouver le texte entour√© de ** et le mettre en <strong>
    });
}

document.getElementById("ajouterEleveBtn").addEventListener("click", async () => {
  let nom = prompt("Pr√©nom de l'√©l√®ve √† ajouter :");
  if (!nom) return;
  nom = nom.charAt(0).toUpperCase() + nom.slice(1).toLowerCase();

  let prof = prompt("Pr√©nom du prof associ√© :");
  if (!prof) return;
  prof = prof.charAt(0).toUpperCase() + prof.slice(1).toLowerCase();

  const domaine = domaineActuel; // utilise la variable globale d√©j√† d√©finie

  try {
    const res = await fetch(`/ajouter-eleve/${encodeURIComponent(domaine)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nom, prof })
    });

    const data = await res.json();

    if (res.ok) {
      alert(`‚úÖ ${data.message}`);
      chargerEvaluation(domaine); // Recharge l'affichage avec le nouvel √©l√®ve
    } else {
      alert(`‚ùå ${data.message}`);
    }
  } catch (err) {
    console.error("Erreur lors de l'ajout :", err);
    alert("Erreur r√©seau.");
  }
});

document.getElementById("supprimerEleveBtn").addEventListener("click", async () => {
  const nom = prompt("Quel √©l√®ve souhaitez-vous supprimer ? (Pr√©nom exact)");
  if (!nom) return;

  const domaine = domaineActuel;

  const confirmation = confirm(`‚ùó Cette action est irr√©versible. Supprimer ${nom} du domaine "${domaine}" ?`);
  if (!confirmation) return;

  try {
    const res = await fetch(`/supprimer-eleve/${encodeURIComponent(domaine)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nom })
    });

    const data = await res.json();

    if (res.ok) {
      alert(`‚úÖ ${data.message}`);
      chargerEvaluation(domaine);
    } else {
      alert(`‚ùå ${data.message}`);
    }
  } catch (err) {
    console.error("Erreur lors de la suppression :", err);
    alert("Erreur r√©seau.");
  }
});

document.getElementById('ajouterCompetenceBtn').addEventListener('click', async function() {
    const rawInput = prompt('Veuillez entrer le code de la comp√©tence √† ajouter (ex : N199, CAL10) :');

    if (!rawInput) return;

    const competence = rawInput.trim().toUpperCase();

    // V√©rifie le format : lettres majuscules suivies de chiffres, sans espace
    const regex = /^[A-Z]+[0-9]+$/;
    if (!regex.test(competence)) {
        alert("‚ùå Format invalide. Utilisez uniquement des lettres majuscules suivies de chiffres (ex: N199, CAL10).");
        return;
    }

    const domaine = domaineActuel;

    try {
        const res = await fetch(`/ajouter-competence/${encodeURIComponent(domaine)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ competence })
        });

        const data = await res.json();

        if (res.ok) {
            alert(`‚úÖ ${data.message}`);
            chargerEvaluation(domaine);
        } else {
            alert(`‚ùå ${data.message}`);
        }
    } catch (err) {
        console.error('Erreur:', err);
        alert("‚ùå Erreur r√©seau lors de l'ajout de la comp√©tence.");
    }
});

document.getElementById('supprimerCompetenceBtn').addEventListener('click', async function() {
    // Afficher un prompt pour que l'utilisateur entre le nom de la comp√©tence √† supprimer
    const competence = prompt('Veuillez entrer le nom de la comp√©tence √† supprimer :');

    // V√©rifier si la comp√©tence est vide
    if (!competence || competence.trim() === '') {
        alert('Le nom de la comp√©tence ne peut pas √™tre vide.');
        return;
    }

    const domaine = domaineActuel;  // Utilise la variable globale `domaineActuel` comme pour les √©l√®ves

    const confirmation = confirm(`‚ùó Cette action est irr√©versible. Voulez-vous supprimer la comp√©tence "${competence}" du domaine "${domaine}" ?`);
    if (!confirmation) return;

    try {
        const res = await fetch(`/supprimer-competence/${encodeURIComponent(domaine)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ competence: competence })
        });

        const data = await res.json();

        if (res.ok) {
            alert(`‚úÖ ${data.message}`);
            chargerEvaluation(domaine); // Recharger l'√©valuation avec la comp√©tence supprim√©e
        } else {
            alert(`‚ùå ${data.message}`);
        }
    } catch (err) {
        console.error('Erreur:', err);
        alert('Une erreur est survenue lors de la suppression de la comp√©tence.');
    }
});


// ------------------------------------------ mettre en tableau CSV ----------------------------------------------
document.getElementById('exportCSVBtn').addEventListener('click', function () {
  const table = document.getElementById('evalTable');
  const rows = Array.from(table.querySelectorAll('tr'));
  
  // G√©n√©rer le contenu CSV
  const csv = rows.map(row => {
    const cells = Array.from(row.querySelectorAll('th, td'));
    return cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
  }).join('\n');

  // Ajouter BOM pour UTF-8
  const BOM = '\uFEFF';
  const csvWithBOM = BOM + csv;

  // Cr√©er un Blob avec encodage UTF-8
  const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  // Cr√©er un lien de t√©l√©chargement
  const a = document.createElement('a');
  a.href = url;
  a.download = `evaluation_${domaineActuel.replace(/\s+/g, '_')}.csv`; // Nom du fichier bas√© sur le domaine
  document.body.appendChild(a);
  a.click(); // Lancer le t√©l√©chargement
  document.body.removeChild(a); // Supprimer le lien une fois le t√©l√©chargement lanc√©
  griserLesCasesDejaValidees();
});

// ------------------------------------------ t√©l√©charger le fichier .JSON-------------------------------------
async function telechargerJSONFiche(domaine) {
  alert('Un fichier de sauvegarde va √™tre t√©l√©charg√©, par pr√©caution.');
  try {
    const res = await fetch(`/evaluations/${encodeURIComponent(domaine)}.json`);
    if (!res.ok) throw new Error("Erreur de r√©cup√©ration du fichier");

    const data = await res.json();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `${domaine}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    console.error("Erreur lors du t√©l√©chargement :", err);
    alert("Impossible de sauvegarder le fichier.");
  }
}


// ------------------------------------------ PRINT ----------------------------------------------
function imprimer() {
    // Lancer l'impression
    window.print();
}

window.addEventListener("beforeprint", (evenement) => {
  griserLesCasesDejaValidees();
});







  </script>

  <script>
    // V√©rifie avec le serveur si l'utilisateur est connect√©
    fetch('/api/check-session')
      .then(res => {
        if (!res.ok) {
          // Si pas connect√©, redirige vers la page de login
          window.location.href = '/login';
        }
      })
      .catch(() => {
        window.location.href = '/login';
      });
  </script>
</body>
</html>

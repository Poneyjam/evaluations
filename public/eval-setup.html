<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cr√©er une √©valuation</title>
  <style>
    :root {
      --green: #4CAF50;
      --lightGreen: #81C784;
      --background-color: #ffffff;
      --white: #fcffff;
      --blue: #007BFF;
      --lightBlue: #96aec7;
      --border-radius: 10px;
      --transition-speed: 0.35s;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: var(--background-color);
      color: #333;
      margin: 0;
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    h1 {
      margin-bottom: 25px;
    }
    
    label {
      font-weight: bold;
      color: var(--blue);
      margin: 10px 0 5px;
    }
    
    input, textarea, select {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      border: 2px solid var(--lightBlue);
      border-radius: var(--border-radius);
      background-color: var(--white);
      font-size: 16px;
      text-align: center;
      transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
      margin-bottom: 20px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 4px rgba(24, 112, 159, 0.15);
    }
    
    .section {
      background-color: var(--white);
      padding: 5px;
      box-shadow: var(--shadow);
      border-radius: var(--border-radius);
      margin-bottom: 2px;
      width: 100%;
      max-width: 600px;
    }
    
    button {
      padding: 12px 24px;
      font-size: 16px;
      background-color: var(--lightBlue);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background-color var(--transition-speed), transform var(--transition-speed);
      box-shadow: var(--shadow);
      margin-top: 10px;
      margin-bottom: 20px;
    }
    
    button:hover {
      background-color: var(--blue);
      transform: scale(1.03);
    }
    
    .liste-dynamique textarea {
      height: 130px;
      resize: vertical;
    }
    .row {
      display: flex;
      gap: 20px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    
    .row .field {
      flex: 1;
      min-width: 120px;
    }
    
    .row.textareas .field textarea {
      height: 130px;
      resize: vertical;
      width: 100%;
      max-width: none;
    }
    
    input.error, textarea.error {
      border: 2px solid red !important;
      box-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
    }
    
    .autocomplete-list {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: -15px auto 15px auto;
      text-align: left;
    }
    
    .autocomplete-list div {
      background-color: white;
      border: 1px solid var(--lightBlue);
      padding: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .autocomplete-list div:hover {
      background-color: var(--lightGreen);
    }
    
    #listeCompetences {
      border: 1px solid var(--lightBlue);
      border-radius: 5px;
      padding: 10px;
      background: #fff;
      max-height: 300px;
      width: 400px;
      overflow-y: auto;
      margin-top: 5px;
      list-style: none;
      font-size: 0.93em;
      text-align: left;
    }
    
    /* Styles Flexbox pour organiser le formulaire √† gauche et les comp√©tences √† droite */
    .form-container {
      display: flex; /* Utilisation de Flexbox pour aligner les √©l√©ments horizontalement */
      justify-content: space-between; /* R√©partition √©gale de l'espace entre les deux colonnes */
      align-items: flex-start; /* Aligner les √©l√©ments au d√©but */
      gap: 10px; /* Espacement entre les colonnes */
      width: 100%;
      max-width: 1000px; /* Limiter la largeur totale √† 1000px */
      margin: 0 auto;
    }
    
    /* Partie gauche du formulaire */
    .form-left {
      flex: 0 0 70%; /* 60% de la largeur pour la partie gauche */
      display: flex;
      flex-direction: column; /* Aligner les √©l√©ments verticalement */
      gap: 15px; /* Espacement entre les champs */
      align-items: center; /* Centrer les √©l√©ments √† gauche */
    }
    
    /* Partie droite pour les comp√©tences */
    .form-right {
      flex: 0 0 25%; /* 35% de la largeur pour la partie droite */
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: flex-start;
    }
    
    /* Liste des comp√©tences (affich√©e √† droite) */
    #listeCompetences {
      list-style-type: none;
      padding: 0;
      margin-top: 10px;
    }
    
    #listeCompetences li {
      padding: 8px;
      background-color: var(--lightBlue);
      margin-bottom: 5px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.2s;
    }
    
    #listeCompetences li:hover {
      background-color: var(--lightGreen);
      color: white;
    }
</style>

    
</head>
<body>
  <h1>üìù Cr√©ation d'une fiche d'√©valuation</h1>
  <form id="evalForm" class="form-container">
    <!-- Partie gauche : Formulaire -->
    <div class="form-left">
      <div class="section row">
        <div class="field">
          <label for="annee">Ann√©e :</label>
          <input type="text" id="annee" name="annee" placeholder="2025-2026" required />
        </div>
        <div class="field">
          <label for="periode">P√©riode :</label>
          <input type="text" id="periode" name="periode" placeholder="P5" required />
        </div>
      </div>

      <div class="section">
        <label for="domaine">Domaine d'apprentissage : Nom de groupe</label>
        <input type="text" id="domaine" name="domaine" placeholder="G√©om√©trie : Les l√©zards" required />
      </div>

      <div class="section row textareas">
        <div class="field">
          <label for="eleves">Pr√©nom - Prof (un par ligne) :</label>
          <textarea id="eleves" placeholder="Haytam - Alexis" required></textarea>
        </div>
        <div class="field">
          <label for="competences">Comp√©tences (une par ligne) :</label>
          <textarea id="competences" placeholder="L23" required></textarea>
        </div>
      </div>

      <button id="submitBtn" style="background-color: var(--green);" type="submit">Cr√©er l'√©valuation</button>
    </div>

    <!-- Partie droite : Comp√©tences -->
    <div class="form-right">
      <button type="button" onclick="afficherCompetences()">Voir les comp√©tences üìö</button>
      <ul id="listeCompetences" style="display:none;"></ul>
    </div>
  </form>

  <p id="message" style="margin-top:2px; font-weight:bold;"></p>
</body>


  <script>
document.getElementById("evalForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const anneeInput = document.getElementById("annee");
  const periodeInput = document.getElementById("periode");
  const domaineInput = document.getElementById("domaine");
  const elevesInput = document.getElementById("eleves");
  const competencesInput = document.getElementById("competences");
  const msg = document.getElementById("message");
  msg.textContent = "";
  msg.style.color = "red";

  // Nettoyage des erreurs visuelles
  [anneeInput, periodeInput, domaineInput, elevesInput, competencesInput].forEach(el => el.classList.remove("error"));

  // ‚úÖ V√©rification ann√©e
  const annee = anneeInput.value.trim();
  const anneeRegex = /^(\d{4})-(\d{4})$/;
  const matchAnnee = annee.match(anneeRegex);
  if (!matchAnnee || parseInt(matchAnnee[2]) !== parseInt(matchAnnee[1]) + 1) {
    anneeInput.classList.add("error");
    msg.textContent = "‚ùå Format incorrect pour l'ann√©e (ex: 2025-2026).";
    return;
  }

  // ‚úÖ V√©rification p√©riode
  const periode = periodeInput.value.trim();
  if (!/^P[1-5]$/.test(periode)) {
    periodeInput.classList.add("error");
    msg.textContent = "‚ùå La p√©riode doit √™tre au format P1 √† P5 (ex: P3).";
    return;
  }

  // ‚úÖ V√©rification et correction √©l√®ves
  const elevesRaw = elevesInput.value.trim().split("\n");
  const eleves = [];

  for (let i = 0; i < elevesRaw.length; i++) {
    const ligne = elevesRaw[i].trim();
    const [prenom1, prenom2] = ligne.split("-").map(x => x?.trim());
    if (!prenom1 || !prenom2) {
      elevesInput.classList.add("error");
      msg.textContent = `‚ùå Ligne ${i + 1} des √©l√®ves invalide. Utilisez "Pr√©nom - Pr√©nom du prof".`;
      return;
    }
    const formatPrenom = (str) => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    eleves.push({ nom: formatPrenom(prenom1), prof: formatPrenom(prenom2) });
  }

  // ‚úÖ V√©rification comp√©tences
  let competences = competencesInput.value.trim().split("\n").map(c => c.trim());
  const competenceRegex = /^[A-Z]{1,}[0-9]{1,}$/;

  for (let i = 0; i < competences.length; i++) {
    if (!competenceRegex.test(competences[i])) {
      competencesInput.classList.add("error");
      msg.textContent = `‚ùå Comp√©tence invalide √† la ligne ${i + 1}. Format attendu en majuscule : LETTRES+CHIFFRE (ex: L23, RM131).`;
      return;
    }
  }

  // Ajout automatique "commentaire"
  if (!competences.includes("commentaire")) {
    competences.push("commentaire");
  }

  const domaine = domaineInput.value.trim(); // pas de validation sp√©cifique ici

  if (/ P[1-5]$/i.test(domaine)) {
    domaineInput.classList.add("error");
    msg.textContent = "‚ùå N'ajoutez pas la p√©riode dans le nom du domaine. Elle sera ajout√©e automatiquement.";
    return;
  }

  // ‚úÖ V√©rifier que toutes les comp√©tences existent
  const competencesInconnues = competences.filter(c => c !== "commentaire" && !(c in competencesMap));
  if (competencesInconnues.length > 0) {
    competencesInput.classList.add("error");
    msg.textContent = `‚ùå Les comp√©tences suivantes sont inconnues : ${competencesInconnues.join(', ')}`;
    return;
  }


  // ‚úÖ Envoi
  const res = await fetch("/setup-evaluation", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ annee, periode, domaine, eleves, competences })
  });

  if (res.ok) {
    msg.textContent = "‚úÖ √âvaluation cr√©√©e avec succ√®s.";
    msg.style.color = "green";

    const elements = document.querySelectorAll('input, textarea');
    elements.forEach(element => {
      element.style.border = '3px double var(--green)';
    });

    document.getElementById('submitBtn').innerText = "Cr√©ation ...";
    document.getElementById('submitBtn').style.backgroundColor = "var(--green)";
    setTimeout(() => { window.location.href = "evaluations.html"; }, 1000);
  } else {
    msg.textContent = "‚ùå Erreur lors de la cr√©ation.";
    msg.style.color = "red";
  }
});

async function afficherCompetences() {
  const liste = document.getElementById("listeCompetences");

  // Si la liste est d√©j√† affich√©e, on la cache
  if (liste.style.display === "block") {
    liste.style.display = "none";
    return;
  }

  try {
    const res = await fetch("/competences");
    const data = await res.json();

    const map = data.competences; // R√©cup√©rer l'objet des comp√©tences
    if (!map || typeof map !== "object") {
      throw new Error("Format incorrect");
    }

    liste.innerHTML = ""; // Vider la liste
    for (const [code, description] of Object.entries(map)) {
      const li = document.createElement("li");
      li.textContent = `${code} ‚Äì ${description}`;

      // Ajouter un √©v√©nement de clic sur chaque √©l√©ment de la liste
      li.addEventListener("click", () => {
        // R√©cup√©rer la valeur actuelle du champ comp√©tences (en gardant le texte existant)
        const currentValue = document.getElementById("competences").value.trim();
        
        // Ajouter un retour √† la ligne et le code de la comp√©tence √† la fin
        const newValue = currentValue + (currentValue ? "\n" : "") + code;

        // Mettre √† jour la valeur du textarea
        document.getElementById("competences").value = newValue;

        // Fermer la liste des comp√©tences
        //liste.style.display = "none";
      });

      liste.appendChild(li); // Ajouter l'√©l√©ment √† la liste
    }

    // Afficher la liste
    liste.style.display = "block";
  } catch (err) {
    console.error("Erreur de chargement des comp√©tences :", err);
    liste.innerHTML = "<li style='color:red;'>Erreur de chargement.</li>";
    liste.style.display = "block";
  }
}






    // D√©tection automatique de l'ann√©e scolaire et de la p√©riode
    window.addEventListener("DOMContentLoaded", () => {
      const now = new Date();
      const month = now.getMonth(); // 0 = Janvier, 11 = D√©cembre
      const year = now.getFullYear();
  
      // D√©terminer l'ann√©e scolaire (septembre √† ao√ªt)
      let startYear, endYear;
      if (month >= 8) { // Septembre √† D√©cembre => ann√©e scolaire commence cette ann√©e
        startYear = year;
        endYear = year + 1;
      } else {
        startYear = year - 1;
        endYear = year;
      }
      const anneeScolaire = `${startYear}-${endYear}`;
  
      // D√©terminer la p√©riode
      let periode;
      if (month === 8 || month === 9) periode = "P1";        // Sept, Oct
      else if (month === 10 || month === 11) periode = "P2"; // Nov, Dec
      else if (month === 0 || month === 1) periode = "P3";   // Jan, Feb
      else if (month === 2 || month === 3) periode = "P4";   // Mar, Apr
      else if (month === 4 || month === 5) periode = "P5";   // May, Jun
      else periode = ""; // Juillet, Ao√ªt => rien (optionnel)
  
      // Pr√©-remplissage
      document.getElementById("annee").value = anneeScolaire;
      document.getElementById("periode").value = periode;
      // Focus dans domaine
      document.getElementById('domaine').focus();
    });


let competencesMap = {};

window.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch("/competences");
    const data = await res.json();

    if (data && typeof data.competences === "object") {
      competencesMap = data.competences;
    } else {
      console.error("Le format JSON est incorrect. Cl√© 'competences' attendue.");
    }
  } catch (err) {
    console.error("Erreur de chargement des comp√©tences :", err);
  }
});


const competencesInput = document.getElementById("competences");
const suggestionsDiv = document.getElementById("suggestions");

competencesInput.addEventListener("input", function () {
  const saisie = this.value.split("\n").pop().trim().toUpperCase();
  suggestionsDiv.innerHTML = "";

  if (saisie.length < 1 || Object.keys(competencesMap).length === 0) return;

  const correspondants = Object.keys(competencesMap)
    .filter(c => c.startsWith(saisie))
    .slice(0, 5);

  correspondants.forEach(code => {
    const item = document.createElement("div");
    item.textContent = `${code} ‚Äì ${competencesMap[code]}`;
    item.title = competencesMap[code]; // description au survol

    item.addEventListener("click", () => {
      const lignes = competencesInput.value.trim().split("\n");
      lignes[lignes.length - 1] = code;
      competencesInput.value = lignes.join("\n") + "\n";
      suggestionsDiv.innerHTML = "";
      competencesInput.focus();
    });

    suggestionsDiv.appendChild(item);
  });
});






  </script>
  
</body>
</html>
